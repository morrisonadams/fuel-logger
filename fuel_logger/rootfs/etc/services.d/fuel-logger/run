#!/usr/bin/with-contenv bashio
# shellcheck shell=bash

bashio::log.info "Starting Fuel Logger service"

export OPENAI_API_KEY="$(bashio::config 'OPENAI_API_KEY')"
export GOOGLE_CLIENT_EMAIL="$(bashio::config 'GOOGLE_CLIENT_EMAIL')"
export GOOGLE_PRIVATE_KEY="$(bashio::config 'GOOGLE_PRIVATE_KEY')"
export GOOGLE_SHEET_ID="$(bashio::config 'GOOGLE_SHEET_ID')"

# Determine the internal port used by the backend. Using the ingress port
# ensures the service keeps listening on the container's port even when the
# mapped host port changes, avoiding Bad Gateway errors.
PORT="$(bashio::addon.ingress_port 2>/dev/null)"
if ! bashio::var.has_value "${PORT}"; then
    PORT="3001"
fi
export PORT
bashio::log.info "Listening on port ${PORT}"

exec npm --prefix /app/backend start
